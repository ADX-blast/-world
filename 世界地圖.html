<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣歷史地圖 - 旗艦中文化導航</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="locations_data.js"></script>

    <style>
        :root { 
            --primary: #00f2fe; 
            --accent: #7000ff;  
            --dark-bg: rgba(10, 15, 25, 0.92); 
            --text-light: #e2e8f0;
            --panel-border: rgba(0, 242, 254, 0.5);
            --neon-shadow: 0 0 15px rgba(0, 242, 254, 0.6);
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: #0b0e14; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        .leaflet-marker-icon { transition: transform 0.2s ease; border-radius: 4px; }
        .leaflet-marker-icon:hover { transform: scale(1.15); filter: drop-shadow(0 0 8px var(--accent)) !important; }
        .leaflet-popup-content-wrapper { background: #0f172a !important; border: 2px solid var(--primary) !important; color: #fff !important; box-shadow: 0 0 15px rgba(0, 242, 254, 0.4); }
        .leaflet-popup-tip { background: var(--primary) !important; }
        .custom-popup-content { padding: 12px; min-width: 180px; }
        
        .source-btn {
            display: inline-block; margin-top: 10px; padding: 6px 12px;
            background: rgba(0, 242, 254, 0.1); color: var(--primary) !important;
            text-decoration: none; border: 1px solid var(--primary); border-radius: 5px; font-size: 12px; font-weight: bold;
        }

        .side-container { position: absolute; top: 25px; right: 25px; z-index: 1001; display: flex; flex-direction: column; gap: 15px; }
        .side-btn { width: 50px; height: 50px; background: var(--dark-bg); border: 1px solid var(--panel-border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); transition: 0.3s; font-size: 20px; }
        .side-btn.active { background: var(--primary); color: #000; box-shadow: 0 0 25px var(--primary); }
        
        .floating-panel { position: fixed; top: 25px; right: 90px; width: 320px; background: var(--dark-bg); backdrop-filter: blur(15px); border: 1px solid var(--panel-border); border-radius: 15px; color: var(--text-light); display: none; z-index: 2000; overflow: hidden; animation: panelFade 0.3s ease; }
        @keyframes panelFade { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .panel-header { padding: 15px 20px; background: rgba(255,255,255,0.08); font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; }
        .event-list { max-height: 60vh; overflow-y: auto; }
        .event-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .event-item:hover { background: rgba(112, 0, 255, 0.2); border-left: 5px solid var(--accent); }

        .controls-overlay { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 1100px; background: var(--dark-bg); backdrop-filter: blur(20px); padding: 18px 25px; border-radius: 20px; border: 1px solid var(--panel-border); z-index: 1000; }
        
        .prog-bg { 
            height: 10px; width: 100%; background: rgba(255,255,255,0.1); border-radius: 5px; 
            cursor: pointer; margin-bottom: 15px; position: relative; display: flex; align-items: center;
        }
        .prog-bar { 
            height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); 
            border-radius: 5px; width: 0%; pointer-events: none; position: relative;
        }
        .prog-handle { 
            position: absolute; 
            right: -10px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 20px; height: 20px; background: #fff; border-radius: 50%; 
            box-shadow: 0 0 15px var(--primary); border: 2px solid var(--primary); 
            cursor: grab; pointer-events: auto; z-index: 10;
        }
        
        .bottom-ui { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .play-btn { width: 45px; height: 45px; background: transparent; border: 2px solid var(--primary); color: var(--primary); border-radius: 50%; cursor: pointer; font-size: 16px; flex-shrink: 0; }
        .time-box { min-width: 200px; border-left: 2px solid var(--panel-border); padding-left: 15px; }
        .main-time { font-size: 22px; font-weight: 800; color: #fff; font-family: 'Consolas', monospace; }
        .sub-time { font-size: 13px; color: var(--primary); font-weight: bold; }

        .input-group { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.08); padding: 8px 12px; border-radius: 12px; border: 1px solid var(--primary); }
        .input-group input { 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; text-align: center; outline: none; border-radius: 4px; 
            -moz-appearance: textfield;
        }
        .input-group input::-webkit-outer-spin-button, .input-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input#inY { width: 80px; font-size: 16px; }
        input#inM, input#inD { width: 30px; }

        .icon-btn { background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 20px; }
        .speed-display { font-size: 12px; color: var(--text-light); width: 85px; text-align: center; }

        #alert-box { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 12px 30px; border-radius: 50px; border: 2px solid var(--primary); z-index: 9999; transition: 0.5s; font-weight: bold; }
        #alert-box.show { top: 30px; }
    </style>
</head>
<body>

<div id="alert-box">警告：無西元 0 年</div>
<div id="map"></div>

<div class="side-container">
    <div class="side-btn" id="navBtn" onclick="togglePanel('eventNav', 'navBtn')"><i class="fa-solid fa-database"></i></div>
    <div class="side-btn" id="infoBtn" onclick="togglePanel('infoPanel', 'infoBtn')"><i class="fa-solid fa-microchip"></i></div>
</div>

<div class="floating-panel" id="eventNav">
    <div class="panel-header"><span>核心事件日誌</span><i class="fa-solid fa-xmark" onclick="closeAllPanels()" style="cursor:pointer"></i></div>
    <div class="event-list" id="eventList"></div>
</div>

<div class="floating-panel" id="infoPanel">
    <div class="panel-header"><span>系統手冊</span><i class="fa-solid fa-xmark" onclick="closeAllPanels()" style="cursor:pointer"></i></div>
    <div style="padding:20px; font-size:13px; color:#94a3b8; line-height:1.6;">
        ● 點擊播放鈕開始/暫停時間。<br>
        ● <b>無西元 0 年</b>：系統自動由 B.C. 1 跳轉至 A.D. 1。<br>
        ● <b>範圍限制</b>：支援西元前 5000 年至今日。
    </div>
</div>

<div class="controls-overlay">
    <div class="prog-bg" id="progCont">
        <div class="prog-bar" id="progBar"><div class="prog-handle" id="progHandle" onmousedown="startPointDrag(event)"></div></div>
    </div>
    <div class="bottom-ui">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="play-btn" id="playBtn" onclick="handlePlayClick()"><i class="fa-solid fa-play"></i></button>
            <div class="time-box">
                <div class="main-time" id="labelYear">西元前 5000 年</div>
                <div class="sub-time" id="labelDate">1 月 1 日</div>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="input-group">
                <input type="tel" id="inY" placeholder="年份">
                <input type="tel" id="inM" placeholder="月">
                <input type="tel" id="inD" placeholder="日">
                <button class="icon-btn" onclick="manualJump()"><i class="fa-solid fa-satellite-dish"></i></button>
            </div>
            <div class="input-group">
                <button class="icon-btn" onclick="adjSpeed(-1)"><i class="fa-solid fa-angles-left"></i></button>
                <div id="spTxt" class="speed-display">1 年 / 秒</div>
                <button class="icon-btn" onclick="adjSpeed(1)"><i class="fa-solid fa-angles-right"></i></button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([23.7, 120.9], 7);
    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=zh-TW', { maxZoom: 20 }).addTo(map);

    const locations = (typeof historicalData !== 'undefined') ? historicalData : [];
    const icons = (typeof iconStyles !== 'undefined') ? iconStyles : { "預設圖片": "https://cdn-icons-png.flaticon.com/512/684/684908.png" };

    const now = new Date();
    const minY = -5000;
    const maxY = now.getFullYear() + (now.getMonth() / 12);
    
    let curY = minY; 
    let isPlaying = false, animFrame, lastT = 0, spIdx = 2;
    const markers = new Map();
    const speeds = [{t:"1 日 / 秒", v:1/365}, {t:"1 月 / 秒", v:1/12}, {t:"1 年 / 秒", v:1}, {t:"10 年 / 秒", v:10}, {t:"100 年 / 秒", v:100}];

    function getInterpolatedPos(loc, year) {
        if (!loc.path) return loc.latlng;
        const p = loc.path;
        if (year <= p[0][0]) return [p[0][1], p[0][2]];
        if (year >= p[p.length-1][0]) return [p[p.length-1][1], p[p.length-1][2]];
        for (let i = 0; i < p.length - 1; i++) {
            if (year >= p[i][0] && year <= p[i+1][0]) {
                const r = (year - p[i][0]) / (p[i+1][0] - p[i][0]);
                return [p[i][1] + (p[i+1][1] - p[i][1]) * r, p[i][2] + (p[i+1][2] - p[i][2]) * r];
            }
        }
    }

    function refresh() {
        locations.forEach(loc => {
            const active = (curY >= loc.startYear && curY <= loc.endYear);
            if (active) {
                const pos = getInterpolatedPos(loc, curY);
                if (!markers.has(loc.name)) {
                    const sourceHtml = (loc.sources || []).map(s => `<a href="${s.url}" target="_blank" class="source-btn">${s.label}</a>`).join("");
                    const m = L.marker(pos, {
                        icon: L.icon({ iconUrl: icons[loc.iconType] || icons["預設圖片"], iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -15] })
                    }).bindPopup(`
                        <div class="custom-popup-content">
                            <strong style="color:var(--primary);">${loc.name}</strong><br>
                            <span style="font-size:11px; opacity:0.7;">${loc.period}</span>
                            <hr style="border-top:1px solid rgba(0, 242, 254, 0.3); margin:8px 0;">
                            <p style="font-size:13px;">${loc.description}</p>
                            ${sourceHtml}
                        </div>
                    `).addTo(map);
                    markers.set(loc.name, m);
                } else { markers.get(loc.name).setLatLng(pos); }
            } else if (markers.has(loc.name)) {
                map.removeLayer(markers.get(loc.name));
                markers.delete(loc.name);
            }
        });

        let floorY = Math.floor(curY);
        let displayY = floorY;
        let prefix = "西元 ";

        if (floorY < 0) {
            displayY = Math.abs(floorY);
            prefix = "西元前 ";
        } else if (floorY === 0) {
            displayY = 1;
        }

        let dateObj = new Date(2024, 0, 1);
        dateObj.setDate(dateObj.getDate() + Math.floor((curY - floorY) * 365.25));
        
        document.getElementById('labelYear').innerText = `${prefix}${displayY} 年`;
        document.getElementById('labelDate').innerText = `${dateObj.getMonth() + 1} 月 ${dateObj.getDate()} 日`;
        
        const progress = ((curY - minY) / (maxY - minY)) * 100;
        document.getElementById('progBar').style.width = `${Math.min(100, Math.max(0, progress))}%`;
        
        updatePlayIcon();
    }

    function triggerAlert(msg) {
        const box = document.getElementById('alert-box');
        box.innerText = msg;
        box.classList.add('show');
        setTimeout(() => box.classList.remove('show'), 3000);
    }

    // --- 核心修正：加入超出範圍跳轉判斷 ---
    function manualJump() {
        let y = parseInt(document.getElementById('inY').value);
        let m = parseInt(document.getElementById('inM').value) || 1;
        let d = parseInt(document.getElementById('inD').value) || 1;

        if (isNaN(y) || y === 0) {
            triggerAlert("請輸入有效年份 (無 0 年)");
            return;
        }

        let targetY = y + ((m - 1) / 12) + ((d - 1) / 365);
        
        if (targetY < minY) {
            triggerAlert(`超出範圍：限制為西元前 ${Math.abs(minY)} 年之後`);
            curY = minY;
        } else if (targetY > maxY) {
            triggerAlert("超出範圍：不能超過當前時間");
            curY = maxY;
        } else {
            curY = targetY;
        }

        isPlaying = false;
        refresh();
    }

    function handlePlayClick() {
        if (curY >= maxY) { curY = minY; refresh(); }
        isPlaying = !isPlaying;
        if (isPlaying) { lastT = 0; animFrame = requestAnimationFrame(run); }
        else { cancelAnimationFrame(animFrame); }
        updatePlayIcon();
    }

    function updatePlayIcon() {
        const btn = document.getElementById('playBtn');
        btn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : (curY >= maxY ? '<i class="fa-solid fa-rotate-right"></i>' : '<i class="fa-solid fa-play"></i>');
    }

    function run(t) {
        if (!isPlaying) return;
        if (!lastT) lastT = t;
        const delta = (t - lastT) / 1000;
        let nextY = curY + speeds[spIdx].v * delta;
        
        if (curY < 0 && nextY >= 0) { nextY = 1.0; }

        curY = nextY;
        if (curY >= maxY) { curY = maxY; isPlaying = false; refresh(); return; }
        refresh();
        lastT = t;
        animFrame = requestAnimationFrame(run);
    }

    function startPointDrag(e) {
        e.preventDefault();
        const onMouseMove = (me) => {
            const rect = document.getElementById('progCont').getBoundingClientRect();
            let p = (me.clientX - rect.left) / rect.width;
            p = Math.max(0, Math.min(1, p));
            curY = minY + (maxY - minY) * p;
            refresh();
        };
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function togglePanel(panelId, btnId) {
        const p = document.getElementById(panelId);
        const isOn = p.style.display === 'block';
        closeAllPanels();
        if (!isOn) { p.style.display = 'block'; document.getElementById(btnId).classList.add('active'); }
    }

    function closeAllPanels() {
        document.querySelectorAll('.floating-panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
    }

    function adjSpeed(dir) { 
        spIdx = Math.max(0, Math.min(speeds.length-1, spIdx + dir)); 
        document.getElementById('spTxt').innerText = speeds[spIdx].t; 
    }
    
    document.getElementById('progCont').onclick = function(e) {
        if (e.target.id === 'progHandle') return;
        const rect = this.getBoundingClientRect();
        let p = (e.clientX - rect.left) / rect.width;
        curY = minY + (maxY - minY) * Math.max(0, Math.min(1, p));
        refresh();
    };

    function initList() {
        const container = document.getElementById('eventList');
        if (!container || locations.length === 0) return;
        [...locations].sort((a,b) => a.startYear - b.startYear).forEach(loc => {
            const item = document.createElement('div');
            item.className = 'event-item';
            item.innerHTML = `<div><b>${loc.name}</b><br><small>${loc.period}</small></div>`;
            item.onclick = () => { 
                curY = loc.startYear; 
                refresh(); 
                map.flyTo(getInterpolatedPos(loc, curY), 10); 
                if(window.innerWidth < 768) closeAllPanels();
            };
            container.appendChild(item);
        });
    }

    window.onload = () => { initList(); refresh(); };
</script>
</body>
</html>
